import{z as e,A as n,B as o,q as r,s as t,l as i}from"./index-CgsE51xo.js";const s="https://cdn.jsdmirror.com/gh/shangxueink/koishi-registry-aggregator@gh-pages/market.json";function a(){return i("market_endpoint")||"https://cdn.jsdmirror.com/gh/shangxueink/koishi-registry-aggregator@gh-pages/market.json"}function l(i={}){const{endpoint:s=a(),isConsoleOutput:l=!0,isShowToast:g=!1,loadingText:p="加载插件数据中..."}=i;return l&&(console.log("-------[fetchMarketData]-------"),console.log("正在请求插件市场数据:",s),console.log("-------[fetchMarketData]-------")),new Promise(((i,a)=>{g&&e({title:p,mask:!0}),n({url:s,method:"GET",timeout:3e4,header:{"Content-Type":"application/json"},success:e=>{var n,t;if(l&&(console.log("-------[success]-------"),console.log("插件市场数据请求成功"),console.log("状态码:",e.statusCode),console.log("数据大小:",JSON.stringify(e.data).length,"bytes"),console.log("插件数量:",(null==(t=null==(n=e.data)?void 0:n.objects)?void 0:t.length)||0),console.log("-------[success]-------")),200!==e.statusCode)throw new Error(`HTTP ${e.statusCode}: 请求失败`);{const n=function(e){if(!e||!e.objects)return{forceTime:0,mirror:"",plugins:[],categories:{},badges:{}};const n=e.objects.map(((e,n)=>{var o,r,t,i,s,a;return{id:n+1,name:(null==(o=e.package)?void 0:o.name)||e.shortname||"unknown",shortname:e.shortname||"",version:(null==(r=e.package)?void 0:r.version)||"0.0.0",description:c(e),author:u(e),icon:"",category:e.category||"other",verified:e.verified||!1,preview:(null==(t=e.manifest)?void 0:t.preview)||!1,insecure:e.insecure||!1,portable:e.portable||!1,newborn:d(e.createdAt),ignored:e.ignored||!1,downloads:(null==(i=e.downloads)?void 0:i.lastMonth)||0,dependents:e.dependents||0,rating:e.rating||0,createdAt:e.createdAt||"",updatedAt:e.updatedAt||"",license:e.license||(null==(s=e.package)?void 0:s.license)||"",keywords:(null==(a=e.package)?void 0:a.keywords)||[],installSize:e.installSize||0,publishSize:e.publishSize||0,score:e.score||{},_raw:e}})),o={},r={verified:0,preview:0,insecure:0,portable:0,newborn:0};return n.forEach((e=>{o[e.category]=(o[e.category]||0)+1,e.verified&&r.verified++,e.preview&&r.preview++,e.insecure&&r.insecure++,e.portable&&r.portable++,e.newborn&&r.newborn++})),{forceTime:e.forceTime||0,mirror:e.mirror||"",plugins:n,categories:o,badges:r,total:n.length}}(e.data);g&&(o(),r({title:"加载完成",icon:"success",duration:1500})),i(n)}},fail:e=>{l&&(console.log("-------[fail]-------"),console.log("插件市场数据请求失败:",e),console.log("-------[fail]-------")),g&&o(),t({title:"加载失败",content:"无法获取插件市场数据，请检查网络连接",showCancel:!1}),a(e)}})}))}function c(e){var n,o;if(null==(n=e.manifest)?void 0:n.description){const n=e.manifest.description;return n.zh||n.en||n}return(null==(o=e.package)?void 0:o.description)||"暂无描述"}function u(e){var n,o,r,t,i,s,a;return(null==(o=null==(n=e.package)?void 0:n.publisher)?void 0:o.username)?e.package.publisher.username:(null==(i=null==(t=null==(r=e.package)?void 0:r.maintainers)?void 0:t[0])?void 0:i.username)?e.package.maintainers[0].username:(null==(a=null==(s=e.package)?void 0:s._npmUser)?void 0:a.name)?e.package._npmUser.name:"unknown"}function d(e){if(!e)return!1;const n=new Date(e).getTime();return Date.now()-n<2592e6}export{s as D,l as f};
