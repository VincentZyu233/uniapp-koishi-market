import{c as t,o as e,a,w as r,f as s,F as n,g as c,d as o,t as l,b as i,N as p,e as u,z as y,M as d,i as g,h as m,j as h}from"./index-fpvSXMFF.js";import{_ as f}from"./_plugin-vue_export-helper.BCo6x5W8.js";const k=f({__name:"rich-text-parser",props:{text:{type:String,default:""},parseImages:{type:Boolean,default:!0},parseLinks:{type:Boolean,default:!0},showFullUrl:{type:Boolean,default:!0}},setup(f){const k=f,b=t((()=>k.text?_(k.text):[])),_=t=>{if(!t)return[];t=x(t);const e=[];let a=0;const r=[{type:"image",regex:/!\[([^\]]*)\]\(([^)]+)\)/g,priority:0},{type:"link",regex:/\[([^\[\]]*(?:\[[^\]]*\][^\[\]]*)*)\]\(([^)]+)\)/g,priority:1},{type:"ruby",regex:/\[RUBY:([^|]+)\|([^\]]+)\]/g,priority:2},{type:"bold",regex:/\*\*([^*]+)\*\*|__([^_]+)__/g,priority:3},{type:"italic",regex:new RegExp("(?<!\\*)\\*([^*\\n]+)\\*(?!\\*)|(?<!_)_([^_\\n]+)_(?!_)","g"),priority:4},{type:"code",regex:/`([^`]+)`/g,priority:5}],s=[];r.forEach((e=>{if("image"===e.type&&!k.parseImages||"link"===e.type&&!k.parseLinks)return;let a;const r=new RegExp(e.regex);for(;null!==(a=r.exec(t));)s.push({type:e.type,priority:e.priority,start:a.index,end:r.lastIndex,match:a})})),s.sort(((t,e)=>t.start-e.start));const n=[];for(let c=0;c<s.length;c++){const t=s[c];let e=!1;for(let a=0;a<n.length;a++){const r=n[a];if(!(t.end<=r.start||t.start>=r.end)){if(!(t.priority<r.priority)){e=!0;break}n.splice(a,1),a--}}e||n.push(t)}if(n.sort(((t,e)=>t.start-e.start)),n.forEach((r=>{if(a<r.start){const s=t.substring(a,r.start);s&&e.push({type:"text",content:s})}switch(r.type){case"ruby":e.push({type:"ruby",base:r.match[1],rt:r.match[2]});break;case"image":e.push({type:"image",src:r.match[2],alt:r.match[1]||""});break;case"link":const t=$(r.match[1]);e.push({type:"link",content:t,url:r.match[2]}),k.showFullUrl&&e.push({type:"link-url",content:r.match[2]});break;case"bold":e.push({type:"bold",content:r.match[1]||r.match[2]});break;case"italic":e.push({type:"italic",content:r.match[1]||r.match[2]});break;case"code":e.push({type:"code",content:r.match[1]})}a=r.end})),a<t.length){const r=t.substring(a);r&&e.push({type:"text",content:r})}return e},x=t=>t=(t=t.replace(/<ruby>(.*?)<rp>.*?<\/rp><rt>(.*?)<\/rt><rp>.*?<\/rp><\/ruby>/g,"[RUBY:$1|$2]")).replace(/<ruby>(.*?)<rt>(.*?)<\/rt><\/ruby>/g,"[RUBY:$1|$2]"),$=t=>t=(t=(t=(t=(t=t.replace(/\[RUBY:([^|]+)\|[^\]]+\]/g,"$1")).replace(/<ruby>([^<]+)<rp>[^<]*<\/rp><rt>[^<]+<\/rt><rp>[^<]*<\/rp><\/ruby>/g,"$1")).replace(/<ruby>([^<]+)<rt>[^<]+<\/rt><\/ruby>/g,"$1")).replace(/\*\*([^*]+)\*\*/g,"$1")).replace(/__([^_]+)__/g,"$1"),w=t=>{console.log("Link clicked:",t),d({data:t,success:()=>{y({title:"链接已复制",icon:"success",duration:1500})}})};return(t,d)=>{const f=g,_=m,x=h;return e(),a(_,{class:"rich-text-container"},{default:r((()=>[(e(!0),s(n,null,c(b.value,((t,c)=>(e(),s(n,{key:c},["text"===t.type?(e(),a(f,{key:0,class:"normal-text"},{default:r((()=>[o(l(t.content),1)])),_:2},1024)):"bold"===t.type?(e(),a(f,{key:1,class:"bold-text"},{default:r((()=>[o(l(t.content),1)])),_:2},1024)):"italic"===t.type?(e(),a(f,{key:2,class:"italic-text"},{default:r((()=>[o(l(t.content),1)])),_:2},1024)):"code"===t.type?(e(),a(f,{key:3,class:"code-text"},{default:r((()=>[o(l(t.content),1)])),_:2},1024)):"ruby"===t.type?(e(),a(_,{key:4,class:"ruby-container"},{default:r((()=>[i(_,{class:"ruby-base"},{default:r((()=>[i(f,{class:"ruby-text"},{default:r((()=>[o(l(t.base),1)])),_:2},1024)])),_:2},1024),i(_,{class:"ruby-annotation"},{default:r((()=>[i(f,{class:"ruby-rt"},{default:r((()=>[o(l(t.rt),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)):"image"===t.type?(e(),a(x,{key:5,src:t.src,alt:t.alt,class:"inline-image",mode:"widthFix",onError:t=>(t=>{console.warn("Image load failed:",b.value[t])})(c),onClick:p((e=>(t=>{console.log("Image clicked:",t);const e=k.text,a=t.alt.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=t.src.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(`\\[!\\[${a}\\]\\(${r}\\)\\]\\(([^)]+)\\)`),n=e.match(s);if(n){const t=n[1];return console.log("Found link wrapping image (format 1):",t),void w(t)}const c=`![${t.alt}](${t.src})`,o=e.indexOf(c);if(-1!==o){const t=e.substring(o+c.length).match(/^\]\(([^)]+)\)/);if(t){const e=t[1];return console.log("Found link wrapping image (format 2):",e),void w(e)}}if(t.src&&t.src.includes("npmjs.com")){const e=t.src.match(/\/badge\/([^\/\?]+)/);if(e){const t=decodeURIComponent(e[1]);return void w(`https://www.npmjs.com/package/${t}`)}}if("npm"===t.alt){const t=e.match(/koishi-plugin-[a-z0-9-]+/);if(t){const e=`https://www.npmjs.com/package/${t[0]}`;return void w(e)}}y({title:"这是一个徽章图片",icon:"none",duration:1500})})(t)),["stop"])},null,8,["src","alt","onError","onClick"])):"link"===t.type?(e(),a(f,{key:6,class:"link-text",onClick:p((e=>w(t.url)),["stop"])},{default:r((()=>[o(l(t.content),1)])),_:2},1032,["onClick"])):"link-url"===t.type?(e(),a(f,{key:7,class:"link-url"},{default:r((()=>[o(" ("+l(t.content)+") ",1)])),_:2},1024)):"emoji"===t.type?(e(),a(f,{key:8,class:"emoji-text"},{default:r((()=>[o(l(t.content),1)])),_:2},1024)):u("",!0)],64)))),128))])),_:1})}}},[["__scopeId","data-v-9aa5eb0f"]]);export{k as R};
