<template>
	<view class="market-page">
		<!-- È°∂ÈÉ®ÊêúÁ¥¢Ê†è -->
		<search-header 
			v-model="searchWords"
			@search="handleSearch"
			@clear="handleClearSearch"
		/>
		
		<!-- ‰∏ª‰ΩìÂÜÖÂÆπÂå∫Âüü -->
		<view class="content">
			<!-- ‰æßËæπÂàÜÁ±ªÊ†è -->
			<market-sidebar
				:collapsed="sidebarCollapsed"
				:market-info="marketInfo"
				:sort-options="sortOptions"
				:active-sort="activeSort"
				:sort-order="sortOrder"
				:badges="badges"
				:active-badges="activeBadges"
				:categories="categories"
				:active-category="activeCategory"
				@toggle="toggleSidebar"
				@sort-change="toggleSort"
				@badge-change="toggleBadge"
				@category-change="toggleCategory"
			/>
			
			<!-- Êèí‰ª∂ÂàóË°® -->
			<view class="plugin-list" :class="{ 'sidebar-collapsed': sidebarCollapsed }">
				<!-- ÁªìÊûúÁªüËÆ° -->
				<view class="result-header">
					<text class="result-count">ÂÖ±ÊâæÂà∞ {{ filteredPlugins.length }} ‰∏™Êèí‰ª∂</text>
					<view class="header-actions">
						<view class="refresh-btn" @click="refreshPlugins" :class="{ loading: isLoading }">
							<text class="refresh-icon">üîÑ</text>
							<text class="refresh-text">{{ isLoading ? 'Âä†ËΩΩ‰∏≠...' : 'Âà∑Êñ∞' }}</text>
						</view>
					</view>
				</view>
				
				<!-- Âä†ËΩΩÁä∂ÊÄÅ -->
				<view v-if="isLoading && plugins.length === 0" class="loading-state">
					<view class="loading-spinner"></view>
					<text class="loading-text">Ê≠£Âú®Âä†ËΩΩÊèí‰ª∂Êï∞ÊçÆ...</text>
				</view>
				
				<!-- Êèí‰ª∂Âç°ÁâáÂàóË°® -->
				<scroll-view class="plugin-scroll" scroll-y v-else>
					<view class="plugin-grid">
						<plugin-card
							v-for="plugin in paginatedPlugins" 
							:key="plugin.id"
							:plugin="plugin"
							@click="openPlugin"
						/>
					</view>
					
					<!-- Á©∫Áä∂ÊÄÅ -->
					<view v-if="filteredPlugins.length === 0" class="empty-state">
						<text class="empty-icon">üì¶</text>
						<text class="empty-text">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Êèí‰ª∂</text>
					</view>
					
					<!-- ÂàÜÈ°µ -->
					<view v-if="totalPages > 1" class="pagination">
						<view 
							class="page-btn" 
							:class="{ disabled: currentPage === 1 }"
							@click="prevPage"
						>‰∏ä‰∏ÄÈ°µ</view>
						<view class="page-info">{{ currentPage }} / {{ totalPages }}</view>
						<view 
							class="page-btn"
							:class="{ disabled: currentPage === totalPages }"
							@click="nextPage"
						>‰∏ã‰∏ÄÈ°µ</view>
					</view>
				</scroll-view>
			</view>
		</view>
	</view>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { fetchMarketData } from '@/utils/request.js'
import PluginCard from '@/components/plugin-card/plugin-card.vue'
import MarketSidebar from '@/components/market-sidebar/market-sidebar.vue'
import SearchHeader from '@/components/search-header/search-header.vue'

// ÊêúÁ¥¢Áõ∏ÂÖ≥
const searchWords = ref([])

// ‰æßËæπÊ†èÁä∂ÊÄÅ
const sidebarCollapsed = ref(false)

// Âä†ËΩΩÁä∂ÊÄÅ
const isLoading = ref(false)
const loadError = ref(null)

// ÊéíÂ∫èÁõ∏ÂÖ≥
const activeSort = ref('default')
const sortOrder = ref('desc')

const sortOptions = [
	{ key: 'default', label: 'ÈªòËÆ§ÊéíÂ∫è', icon: '‚≠ê' },
	{ key: 'download', label: '‰∏ãËΩΩÈáè', icon: 'üì•' },
	{ key: 'rating', label: 'ËØÑÂàÜ', icon: '‚ù§Ô∏è' },
	{ key: 'updated', label: 'Êõ¥Êñ∞Êó∂Èó¥', icon: 'üïê' },
	{ key: 'created', label: 'ÂèëÂ∏ÉÊó∂Èó¥', icon: 'üìÖ' }
]

// Á≠õÈÄâÂæΩÁ´†
const activeBadges = ref([])
const badges = ref([
	{ key: 'verified', label: 'ÂÆòÊñπËÆ§ËØÅ', icon: '‚úì', count: 0 },
	{ key: 'preview', label: 'È¢ÑËßàÁâàÊú¨', icon: 'üëÅ', count: 0 },
	{ key: 'insecure', label: '‰∏çÂÆâÂÖ®', icon: '‚ö†', count: 0 },
	{ key: 'portable', label: '‰æøÊê∫ÁâàÊú¨', icon: 'üì¶', count: 0 },
	{ key: 'newborn', label: 'Êñ∞ÂèëÂ∏É', icon: 'üéâ', count: 0 }
])

// ÂàÜÁ±ª
const activeCategory = ref('')
const categories = ref([
	{ key: 'adapter', label: 'ÈÄÇÈÖçÂô®', icon: 'üîå', count: 0 },
	{ key: 'extension', label: 'Êâ©Â±ïÂäüËÉΩ', icon: 'üß©', count: 0 },
	{ key: 'tool', label: 'ÂÆûÁî®Â∑•ÂÖ∑', icon: 'üîß', count: 0 },
	{ key: 'game', label: 'Â®±‰πêÁé©Ê≥ï', icon: 'üéÆ', count: 0 },
	{ key: 'image', label: 'ÂõæÁâáÊúçÂä°', icon: 'üñº', count: 0 },
	{ key: 'manage', label: 'ÁÆ°ÁêÜÂ∑•ÂÖ∑', icon: '‚öôÔ∏è', count: 0 },
	{ key: 'general', label: 'ÈÄöÁî®ÂäüËÉΩ', icon: 'üì¶', count: 0 },
	{ key: 'other', label: 'ÂÖ∂‰ªñ', icon: 'üìã', count: 0 }
])

// Êèí‰ª∂Êï∞ÊçÆ
const plugins = ref([])
const marketInfo = ref({})
const currentPage = ref(1)
const pageSize = ref(24)

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredPlugins = computed(() => {
	let result = plugins.value
	
	// ÊåâÊêúÁ¥¢ËØçÁ≠õÈÄâ
	if (searchWords.value.length > 0) {
		result = result.filter(plugin => {
			return searchWords.value.every(word => {
				const lowerWord = word.toLowerCase()
				return plugin.name.toLowerCase().includes(lowerWord) ||
					   plugin.description.toLowerCase().includes(lowerWord) ||
					   plugin.author.toLowerCase().includes(lowerWord)
			})
		})
	}
	
	// ÊåâÂàÜÁ±ªÁ≠õÈÄâ
	if (activeCategory.value) {
		result = result.filter(plugin => plugin.category === activeCategory.value)
	}
	
	// ÊåâÂæΩÁ´†Á≠õÈÄâ
	if (activeBadges.value.length > 0) {
		result = result.filter(plugin => {
			return activeBadges.value.every(badge => plugin[badge])
		})
	}
	
	// ÊéíÂ∫è
	result = [...result].sort((a, b) => {
		let aVal, bVal
		switch (activeSort.value) {
			case 'download':
				aVal = a.downloads || 0
				bVal = b.downloads || 0
				break
			case 'rating':
				aVal = a.rating || 0
				bVal = b.rating || 0
				break
			case 'updated':
				aVal = new Date(a.updatedAt || 0).getTime()
				bVal = new Date(b.updatedAt || 0).getTime()
				break
			case 'created':
				aVal = new Date(a.createdAt || 0).getTime()
				bVal = new Date(b.createdAt || 0).getTime()
				break
			default:
				return 0
		}
		return sortOrder.value === 'desc' ? bVal - aVal : aVal - bVal
	})
	
	return result
})

const totalPages = computed(() => {
	return Math.ceil(filteredPlugins.value.length / pageSize.value)
})

const paginatedPlugins = computed(() => {
	const start = (currentPage.value - 1) * pageSize.value
	const end = start + pageSize.value
	return filteredPlugins.value.slice(start, end)
})

// ÊñπÊ≥ï
const toggleSidebar = () => {
	sidebarCollapsed.value = !sidebarCollapsed.value
}

const handleSearch = (word) => {
	currentPage.value = 1
}

const handleClearSearch = () => {
	currentPage.value = 1
}

const toggleSort = (key) => {
	if (activeSort.value === key) {
		sortOrder.value = sortOrder.value === 'desc' ? 'asc' : 'desc'
	} else {
		activeSort.value = key
		sortOrder.value = 'desc'
	}
	currentPage.value = 1
}

const toggleBadge = (key) => {
	const index = activeBadges.value.indexOf(key)
	if (index > -1) {
		activeBadges.value.splice(index, 1)
	} else {
		activeBadges.value.push(key)
	}
	currentPage.value = 1
}

const toggleCategory = (key) => {
	if (activeCategory.value === key) {
		activeCategory.value = ''
	} else {
		activeCategory.value = key
	}
	currentPage.value = 1
}

const openPlugin = (plugin) => {
	uni.navigateTo({
		url: `/pages/plugin/detail?id=${plugin.id}`
	})
}

const prevPage = () => {
	if (currentPage.value > 1) {
		currentPage.value--
	}
}

const nextPage = () => {
	if (currentPage.value < totalPages.value) {
		currentPage.value++
	}
}

// Âä†ËΩΩÊèí‰ª∂Êï∞ÊçÆ
const loadPlugins = async () => {
	try {
		isLoading.value = true
		loadError.value = null
		
		console.log('ÂºÄÂßãÂä†ËΩΩ Koishi Êèí‰ª∂Â∏ÇÂú∫Êï∞ÊçÆ...')
		
		// Ë∞ÉÁî®ËØ∑Ê±ÇÂáΩÊï∞Ëé∑ÂèñÊï∞ÊçÆ
		const data = await fetchMarketData({
			isConsoleOutput: true,
			isShowToast: true
		})
		
		console.log('Êï∞ÊçÆÂä†ËΩΩÊàêÂäü:', data)
		
		// ËÆæÁΩÆÊèí‰ª∂ÂàóË°®
		plugins.value = data.plugins || []
		
		// ‰øùÂ≠òÂ∏ÇÂú∫‰ø°ÊÅØ
		marketInfo.value = {
			forceTime: data.forceTime,
			mirror: data.mirror,
			total: data.total
		}
		
		// Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
		updateCounts(data)
		
		console.log(`ÊàêÂäüÂä†ËΩΩ ${plugins.value.length} ‰∏™Êèí‰ª∂`)
		
	} catch (error) {
		console.error('Âä†ËΩΩÊèí‰ª∂Êï∞ÊçÆÂ§±Ë¥•:', error)
		loadError.value = error.message || 'Âä†ËΩΩÂ§±Ë¥•'
		
		uni.showModal({
			title: 'Âä†ËΩΩÂ§±Ë¥•',
			content: 'Êó†Ê≥ïÂä†ËΩΩÊèí‰ª∂Êï∞ÊçÆÔºåËØ∑Á®çÂêéÈáçËØï',
			confirmText: 'ÈáçËØï',
			success: (res) => {
				if (res.confirm) {
					loadPlugins()
				}
			}
		})
	} finally {
		isLoading.value = false
	}
}

const updateCounts = (data) => {
	// Êõ¥Êñ∞ÂæΩÁ´†ËÆ°Êï∞Ôºà‰ªéËøîÂõûÁöÑÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÔºâ
	if (data.badges) {
		badges.value.forEach(badge => {
			badge.count = data.badges[badge.key] || 0
		})
	}
	
	// Êõ¥Êñ∞ÂàÜÁ±ªËÆ°Êï∞Ôºà‰ªéËøîÂõûÁöÑÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÔºâ
	if (data.categories) {
		categories.value.forEach(category => {
			category.count = data.categories[category.key] || 0
		})
	}
	
	// Â¶ÇÊûúÊ≤°ÊúâËøîÂõûÁªüËÆ°Êï∞ÊçÆÔºåÂàôÊâãÂä®ËÆ°ÁÆó
	if (!data.badges || !data.categories) {
		badges.value.forEach(badge => {
			badge.count = plugins.value.filter(p => p[badge.key]).length
		})
		
		categories.value.forEach(category => {
			category.count = plugins.value.filter(p => p.category === category.key).length
		})
	}
}

// Âà∑Êñ∞Êï∞ÊçÆ
const refreshPlugins = () => {
	loadPlugins()
}

onMounted(() => {
	loadPlugins()
})
</script>

<style scoped>
.market-page {
	width: 100vw;
	height: 100vh;
	display: flex;
	flex-direction: column;
	background-color: #f5f5f5;
}

/* Â§¥ÈÉ®ÊêúÁ¥¢Ê†è */
.header {
	background-color: #fff;
	padding: 20rpx;
	box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.1);
	z-index: 100;
}

.search-bar {
	display: flex;
	align-items: center;
	background-color: #f5f5f5;
	border-radius: 40rpx;
	padding: 10rpx 20rpx;
}

.search-icon {
	font-size: 32rpx;
	color: #999;
	margin-right: 10rpx;
}

.search-input {
	flex: 1;
	font-size: 28rpx;
	border: none;
	background: transparent;
}

.clear-icon {
	font-size: 32rpx;
	color: #999;
	padding: 0 10rpx;
}

.search-tags {
	margin-top: 20rpx;
	white-space: nowrap;
}

.tag-list {
	display: flex;
	gap: 10rpx;
}

.search-tag {
	display: inline-flex;
	align-items: center;
	padding: 8rpx 20rpx;
	background-color: #409eff;
	color: #fff;
	border-radius: 20rpx;
	font-size: 24rpx;
	white-space: nowrap;
}

.tag-close {
	margin-left: 10rpx;
	font-weight: bold;
}

/* ‰∏ª‰ΩìÂÜÖÂÆπ */
.content {
	flex: 1;
	display: flex;
	overflow: hidden;
}

/* ‰æßËæπÊ†è */
.sidebar {
	width: 400rpx;
	background-color: #fff;
	border-right: 1rpx solid #e8e8e8;
	position: relative;
	transition: width 0.3s;
}

.sidebar.collapsed {
	width: 80rpx;
}

.collapse-btn {
	position: absolute;
	right: 10rpx;
.sidebar-content {
	height: 100%;
	padding: 20rpx;
	padding-top: 100rpx;
}

.market-info {
	background-color: #f5f5f5;
	border-radius: 8rpx;
	padding: 20rpx;
	margin-bottom: 30rpx;
}

.info-item {
	display: flex;
	justify-content: space-between;
	font-size: 24rpx;
	margin-bottom: 8rpx;
}

.info-item:last-child {
	margin-bottom: 0;
}

.info-label {
	color: #999;
}

.info-value {
	color: #409eff;
	font-weight: bold;
}

.filter-group {or: #f5f5f5;
	border-radius: 50%;
	font-size: 24rpx;
	z-index: 10;
}

.sidebar-content {
	height: 100%;
	padding: 20rpx;
	padding-top: 100rpx;
}

.filter-group {
	margin-bottom: 40rpx;
}

.filter-title {
	font-size: 28rpx;
	font-weight: bold;
	color: #333;
	margin-bottom: 20rpx;
}

.filter-item {
	display: flex;
	align-items: center;
	padding: 16rpx 20rpx;
	margin: 8rpx 0;
	border-radius: 8rpx;
	font-size: 26rpx;
	color: #666;
	cursor: pointer;
	transition: all 0.3s;
}

.filter-item:hover {
	background-color: #f5f5f5;
}

.filter-item.active {
	color: #409eff;
	background-color: #ecf5ff;
}

.filter-item.verified.active {
	color: #67c23a;
	background-color: #f0f9ff;
}

.result-header {
	padding: 20rpx 30rpx;
	background-color: #fff;
	border-bottom: 1rpx solid #e8e8e8;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.result-count {
	font-size: 26rpx;
	color: #666;
}

.header-actions {
	display: flex;
	gap: 20rpx;
}

.refresh-btn {
	display: flex;
	align-items: center;
	padding: 10rpx 24rpx;
	background-color: #409eff;
	color: #fff;
	border-radius: 20rpx;
	font-size: 24rpx;
	transition: all 0.3s;
}

.refresh-btn.loading {
	opacity: 0.6;
}

.refresh-icon {
	margin-right: 8rpx;
	display: inline-block;
	animation: rotate 1s linear infinite;
}

.refresh-btn.loading .refresh-icon {
	animation: rotate 1s linear infinite;
}

@keyframes rotate {
	from {
		transform: rotate(0deg);
	}
	to {
		transform: rotate(360deg);
	}
}

.refresh-text {
	white-space: nowrap;
}

/* Âä†ËΩΩÁä∂ÊÄÅ */
.loading-state {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 100rpx 20rpx;
}

.loading-spinner {
	width: 60rpx;
	height: 60rpx;
	border: 4rpx solid #e8e8e8;
	border-top-color: #409eff;
	border-radius: 50%;
	animation: spin 1s linear infinite;
	margin-bottom: 20rpx;
}

@keyframes spin {
	to {
		transform: rotate(360deg);
	}
}

.loading-text {
	font-size: 28rpx;
	color: #999;
}

.plugin-scroll {0rpx;
	font-size: 28rpx;
}

.filter-text {
	flex: 1;
}

.spacer {
	flex: 1;
}

.filter-count,
.order-icon {
	font-size: 24rpx;
	color: #999;
	margin-left: 10rpx;
}

/* Êèí‰ª∂ÂàóË°® */
.plugin-list {
	flex: 1;
	display: flex;
	flex-direction: column;
	background-color: #f5f5f5;
	transition: all 0.3s;
}

.result-header {
	padding: 20rpx 30rpx;
	background-color: #fff;
	border-bottom: 1rpx solid #e8e8e8;
}

.result-count {
	font-size: 26rpx;
	color: #666;
}

.plugin-scroll {
	flex: 1;
	padding: 30rpx;
}

.plugin-grid {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(540rpx, 1fr));
	gap: 30rpx;
	justify-items: center;
}

/* Á©∫Áä∂ÊÄÅ */
.empty-state {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 100rpx 20rpx;
}

.empty-icon {
	font-size: 120rpx;
	margin-bottom: 20rpx;
}

.empty-text {
	font-size: 28rpx;
	color: #999;
}

/* ÂàÜÈ°µ */
.pagination {
	display: flex;
	justify-content: center;
	align-items: center;
	padding: 40rpx 20rpx;
	gap: 20rpx;
}

.page-btn {
	padding: 16rpx 32rpx;
	background-color: #fff;
	border-radius: 8rpx;
	font-size: 26rpx;
	color: #409eff;
	box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.08);
	cursor: pointer;
}

.page-btn.disabled {
	color: #ccc;
	pointer-events: none;
}

.page-info {
	font-size: 26rpx;
	color: #666;
}

/* ÂìçÂ∫îÂºèÂ∏ÉÂ±Ä */
@media (max-width: 768rpx) {
	.plugin-grid {
		grid-template-columns: 1fr;
	}
}
</style>
